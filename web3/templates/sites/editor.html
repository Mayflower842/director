{% extends "base.html" %}

{% block css %}
    {{ block.super }}
{% endblock %}

{% block js %}
    {{ block.super }}
<script type="text/javascript">
var path_endpoint = "{% url 'editor_path' site.id %}";
$(document).ready(function() {
    $.get(path_endpoint, function(data) {
        if (data.error) {
            Messenger().error(data.error);
        }
        else {
            $.each(data.files, function(k, v) {
                var c = (v.type == "f" ? "file" : "folder");
                var node = $("<div><i class='fa fa-fw fa-" + c + "-o'></i> " + $("<div />").text(v.name).html() + "</div>");
                node.addClass(c);
                node.attr("data-name", v.name);
                node.attr("data-depth", 0);
                if (v.type == "d") {
                    node.append(" <i class='exp fa fa-caret-down'>");
                }
                $("#files").append(node);
            });
        }
    });
    $("#files").on("click", ".folder", function(e) {
        e.preventDefault();
        var t = $(this);
        if (t.hasClass("loaded")) {
            // TODO: collapsing and expansion
            return;
        }
        else {
            var depth = parseInt(t.attr("data-depth"));
            var loop_depth = depth;
            var loop_path = "";
            var loop_t = t;
            while (true) {
                loop_depth -= 1;
                if (loop_depth < 0) {
                    break;
                }
                var new_t = loop_t.prevAll("div.folder[data-depth=" + loop_depth + "]:first");
                loop_path = new_t.attr("data-name") + "/" + loop_path;
                loop_t = new_t;
            }
            t.addClass("loaded");
            $.get(path_endpoint + "?path=" + encodeURIComponent(loop_path + t.attr("data-name")), function(data) {
                if (data.error) {
                    Messenger().error(data.error);
                }
                else {
                    $.each(data.files, function(k, v) {
                        var c = (v.type == "f" ? "file" : "folder");
                        var node = $("<div style='margin-left:" + (depth + 1)*20 + "px'><i class='fa fa-fw fa-" + c + "-o'></i> " + $("<div />").text(v.name).html() + "</div>");
                        node.addClass(c);
                        node.attr("data-name", v.name);
                        node.attr("data-depth", depth + 1);
                        t.after(node);
                    });
                    t.find(".exp").removeClass("fa-caret-down").addClass("fa-caret-up");
                }
            });
        }
    });
});
</script>
{% endblock %}

{% block navbar %}
<a href="{% url 'info_site' site.id %}">{{ site.name }}</a>
{% endblock %}

{% block main %}
<div id="files">
</div>
{% endblock %}
